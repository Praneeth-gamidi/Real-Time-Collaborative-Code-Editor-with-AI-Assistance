{
  "version": 3,
  "sources": ["../../lib0/mutex.js", "../../y-monaco/src/y-monaco.js"],
  "sourcesContent": ["/**\n * Mutual exclude for JavaScript.\n *\n * @module mutex\n */\n\n/**\n * @callback mutex\n * @param {function():void} cb Only executed when this mutex is not in the current stack\n * @param {function():void} [elseCb] Executed when this mutex is in the current stack\n */\n\n/**\n * Creates a mutual exclude function with the following property:\n *\n * ```js\n * const mutex = createMutex()\n * mutex(() => {\n *   // This function is immediately executed\n *   mutex(() => {\n *     // This function is not executed, as the mutex is already active.\n *   })\n * })\n * ```\n *\n * @return {mutex} A mutual exclude function\n * @public\n */\nexport const createMutex = () => {\n  let token = true\n  return (f, g) => {\n    if (token) {\n      token = false\n      try {\n        f()\n      } finally {\n        token = true\n      }\n    } else if (g !== undefined) {\n      g()\n    }\n  }\n}\n", "import * as Y from 'yjs'\nimport * as monaco from 'monaco-editor/esm/vs/editor/editor.api.js'\nimport * as error from 'lib0/error'\nimport { createMutex } from 'lib0/mutex'\nimport { Awareness } from 'y-protocols/awareness' // eslint-disable-line\n\nclass RelativeSelection {\n  /**\n   * @param {Y.RelativePosition} start\n   * @param {Y.RelativePosition} end\n   * @param {monaco.SelectionDirection} direction\n   */\n  constructor (start, end, direction) {\n    this.start = start\n    this.end = end\n    this.direction = direction\n  }\n}\n\n/**\n * @param {monaco.editor.IStandaloneCodeEditor} editor\n * @param {monaco.editor.ITextModel} monacoModel\n * @param {Y.Text} type\n */\nconst createRelativeSelection = (editor, monacoModel, type) => {\n  const sel = editor.getSelection()\n  if (sel !== null) {\n    const startPos = sel.getStartPosition()\n    const endPos = sel.getEndPosition()\n    const start = Y.createRelativePositionFromTypeIndex(type, monacoModel.getOffsetAt(startPos))\n    const end = Y.createRelativePositionFromTypeIndex(type, monacoModel.getOffsetAt(endPos))\n    return new RelativeSelection(start, end, sel.getDirection())\n  }\n  return null\n}\n\n/**\n * @param {monaco.editor.IEditor} editor\n * @param {Y.Text} type\n * @param {RelativeSelection} relSel\n * @param {Y.Doc} doc\n * @return {null|monaco.Selection}\n */\nconst createMonacoSelectionFromRelativeSelection = (editor, type, relSel, doc) => {\n  const start = Y.createAbsolutePositionFromRelativePosition(relSel.start, doc)\n  const end = Y.createAbsolutePositionFromRelativePosition(relSel.end, doc)\n  if (start !== null && end !== null && start.type === type && end.type === type) {\n    const model = /** @type {monaco.editor.ITextModel} */ (editor.getModel())\n    const startPos = model.getPositionAt(start.index)\n    const endPos = model.getPositionAt(end.index)\n    return monaco.Selection.createWithDirection(startPos.lineNumber, startPos.column, endPos.lineNumber, endPos.column, relSel.direction)\n  }\n  return null\n}\n\nexport class MonacoBinding {\n  /**\n   * @param {Y.Text} ytext\n   * @param {monaco.editor.ITextModel} monacoModel\n   * @param {Set<monaco.editor.IStandaloneCodeEditor>} [editors]\n   * @param {Awareness?} [awareness]\n   */\n  constructor (ytext, monacoModel, editors = new Set(), awareness = null) {\n    this.doc = /** @type {Y.Doc} */ (ytext.doc)\n    this.ytext = ytext\n    this.monacoModel = monacoModel\n    this.editors = editors\n    this.mux = createMutex()\n    /**\n     * @type {Map<monaco.editor.IStandaloneCodeEditor, RelativeSelection>}\n     */\n    this._savedSelections = new Map()\n    this._beforeTransaction = () => {\n      this.mux(() => {\n        this._savedSelections = new Map()\n        editors.forEach(editor => {\n          if (editor.getModel() === monacoModel) {\n            const rsel = createRelativeSelection(editor, monacoModel, ytext)\n            if (rsel !== null) {\n              this._savedSelections.set(editor, rsel)\n            }\n          }\n        })\n      })\n    }\n    this.doc.on('beforeAllTransactions', this._beforeTransaction)\n    this._decorations = new Map()\n    this._rerenderDecorations = () => {\n      editors.forEach(editor => {\n        if (awareness && editor.getModel() === monacoModel) {\n          // render decorations\n          const currentDecorations = this._decorations.get(editor) || []\n          /**\n           * @type {Array<monaco.editor.IModelDeltaDecoration>}\n           */\n          const newDecorations = []\n          awareness.getStates().forEach((state, clientID) => {\n            if (clientID !== this.doc.clientID && state.selection != null && state.selection.anchor != null && state.selection.head != null) {\n              const anchorAbs = Y.createAbsolutePositionFromRelativePosition(state.selection.anchor, this.doc)\n              const headAbs = Y.createAbsolutePositionFromRelativePosition(state.selection.head, this.doc)\n              if (anchorAbs !== null && headAbs !== null && anchorAbs.type === ytext && headAbs.type === ytext) {\n                let start, end, afterContentClassName, beforeContentClassName\n                if (anchorAbs.index < headAbs.index) {\n                  start = monacoModel.getPositionAt(anchorAbs.index)\n                  end = monacoModel.getPositionAt(headAbs.index)\n                  afterContentClassName = 'yRemoteSelectionHead yRemoteSelectionHead-' + clientID\n                  beforeContentClassName = null\n                } else {\n                  start = monacoModel.getPositionAt(headAbs.index)\n                  end = monacoModel.getPositionAt(anchorAbs.index)\n                  afterContentClassName = null\n                  beforeContentClassName = 'yRemoteSelectionHead yRemoteSelectionHead-' + clientID\n                }\n                newDecorations.push({\n                  range: new monaco.Range(start.lineNumber, start.column, end.lineNumber, end.column),\n                  options: {\n                    className: 'yRemoteSelection yRemoteSelection-' + clientID,\n                    afterContentClassName,\n                    beforeContentClassName\n                  }\n                })\n              }\n            }\n          })\n          this._decorations.set(editor, editor.deltaDecorations(currentDecorations, newDecorations))\n        } else {\n          // ignore decorations\n          this._decorations.delete(editor)\n        }\n      })\n    }\n    /**\n     * @param {Y.YTextEvent} event\n     */\n    this._ytextObserver = event => {\n      this.mux(() => {\n        let index = 0\n        event.delta.forEach(op => {\n          if (op.retain !== undefined) {\n            index += op.retain\n          } else if (op.insert !== undefined) {\n            const pos = monacoModel.getPositionAt(index)\n            const range = new monaco.Selection(pos.lineNumber, pos.column, pos.lineNumber, pos.column)\n            const insert = /** @type {string} */ (op.insert)\n            monacoModel.applyEdits([{ range, text: insert }])\n            index += insert.length\n          } else if (op.delete !== undefined) {\n            const pos = monacoModel.getPositionAt(index)\n            const endPos = monacoModel.getPositionAt(index + op.delete)\n            const range = new monaco.Selection(pos.lineNumber, pos.column, endPos.lineNumber, endPos.column)\n            monacoModel.applyEdits([{ range, text: '' }])\n          } else {\n            throw error.unexpectedCase()\n          }\n        })\n        this._savedSelections.forEach((rsel, editor) => {\n          const sel = createMonacoSelectionFromRelativeSelection(editor, ytext, rsel, this.doc)\n          if (sel !== null) {\n            editor.setSelection(sel)\n          }\n        })\n      })\n      this._rerenderDecorations()\n    }\n    ytext.observe(this._ytextObserver)\n    {\n      const ytextValue = ytext.toString()\n      if (monacoModel.getValue() !== ytextValue) {\n        monacoModel.setValue(ytextValue)\n      }\n    }\n    this._monacoChangeHandler = monacoModel.onDidChangeContent(event => {\n      // apply changes from right to left\n      this.mux(() => {\n        this.doc.transact(() => {\n          event.changes.sort((change1, change2) => change2.rangeOffset - change1.rangeOffset).forEach(change => {\n            ytext.delete(change.rangeOffset, change.rangeLength)\n            ytext.insert(change.rangeOffset, change.text)\n          })\n        }, this)\n      })\n    })\n    this._monacoDisposeHandler = monacoModel.onWillDispose(() => {\n      this.destroy()\n    })\n    if (awareness) {\n      editors.forEach(editor => {\n        editor.onDidChangeCursorSelection(() => {\n          if (editor.getModel() === monacoModel) {\n            const sel = editor.getSelection()\n            if (sel === null) {\n              return\n            }\n            let anchor = monacoModel.getOffsetAt(sel.getStartPosition())\n            let head = monacoModel.getOffsetAt(sel.getEndPosition())\n            if (sel.getDirection() === monaco.SelectionDirection.RTL) {\n              const tmp = anchor\n              anchor = head\n              head = tmp\n            }\n            awareness.setLocalStateField('selection', {\n              anchor: Y.createRelativePositionFromTypeIndex(ytext, anchor),\n              head: Y.createRelativePositionFromTypeIndex(ytext, head)\n            })\n          }\n        })\n        awareness.on('change', this._rerenderDecorations)\n      })\n      this.awareness = awareness\n    }\n  }\n\n  destroy () {\n    this._monacoChangeHandler.dispose()\n    this._monacoDisposeHandler.dispose()\n    this.ytext.unobserve(this._ytextObserver)\n    this.doc.off('beforeAllTransactions', this._beforeTransaction)\n    if (this.awareness) {\n      this.awareness.off('change', this._rerenderDecorations)\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
